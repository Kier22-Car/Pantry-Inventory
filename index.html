// App.jsx
import React, { useState, useEffect } from "react";

const LOCAL_STORAGE_KEY = "pantryAppData";

function getToday() {
  return new Date().toISOString().split("T")[0];
}

function App() {
  const [pantries, setPantries] = useState([]); // [{ id, name, location, items: [{name, qty, lastUpdated}] }]
  const [supply, setSupply] = useState([]); // [{name, qty}]
  const [selectedPantryId, setSelectedPantryId] = useState(null);
  const [view, setView] = useState("manage"); // manage, overview, supply

  // Load from localStorage
  useEffect(() => {
    const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
    if (saved) {
      setPantries(saved.pantries || []);
      setSupply(saved.supply || []);
    }
  }, []);

  // Save to localStorage
  useEffect(() => {
    localStorage.setItem(
      LOCAL_STORAGE_KEY,
      JSON.stringify({ pantries, supply })
    );
  }, [pantries, supply]);

  // Create new pantry
  const createPantry = (name, location) => {
    const id = Date.now().toString();
    const newPantry = { id, name, location, items: [] };
    setPantries([...pantries, newPantry]);
    setSelectedPantryId(id);
    setView("manage");
  };

  const selectedPantry = pantries.find((p) => p.id === selectedPantryId);

  // Add or update item in pantry
  const updatePantryItem = (itemName, qtyChange) => {
    if (!selectedPantry) return;
    if (qtyChange === 0) return;

    // Update pantry item qty and lastUpdated
    let newItems = [...selectedPantry.items];
    const itemIndex = newItems.findIndex((i) => i.name === itemName);

    if (itemIndex === -1 && qtyChange > 0) {
      // Add new item
      newItems.push({ name: itemName, qty: qtyChange, lastUpdated: getToday() });
    } else if (itemIndex !== -1) {
      const currentQty = newItems[itemIndex].qty;
      const newQty = currentQty + qtyChange;
      if (newQty < 0) return alert("Cannot have negative quantity");
      if (newQty === 0) {
        newItems.splice(itemIndex, 1);
      } else {
        newItems[itemIndex] = { ...newItems[itemIndex], qty: newQty, lastUpdated: getToday() };
      }
    }

    // Update pantries state
    setPantries(
      pantries.map((p) =>
        p.id === selectedPantry.id ? { ...p, items: newItems } : p
      )
    );

    // If pantry restock (qtyChange > 0), reduce supply stock
    if (qtyChange > 0) {
      updateSupply(itemName, -qtyChange);
    }
  };

  // Add or update supply stock
  const updateSupply = (itemName, qtyChange) => {
    let newSupply = [...supply];
    const idx = newSupply.findIndex((i) => i.name === itemName);

    if (idx === -1 && qtyChange > 0) {
      newSupply.push({ name: itemName, qty: qtyChange });
    } else if (idx !== -1) {
      const newQty = newSupply[idx].qty + qtyChange;
      if (newQty < 0) return alert("Supply cannot be negative");
      if (newQty === 0) {
        newSupply.splice(idx, 1);
      } else {
        newSupply[idx] = { ...newSupply[idx], qty: newQty };
      }
    } else {
      return alert("Supply not enough to remove");
    }
    setSupply(newSupply);
  };

  // Compute combined inventory (all pantries) for overview
  const combinedInventory = () => {
    const combined = {};
    pantries.forEach((p) => {
      p.items.forEach(({ name, qty }) => {
        combined[name] = (combined[name] || 0) + qty;
      });
    });
    return Object.entries(combined).map(([name, qty]) => ({ name, qty }));
  };

  return (
    <div style={{ maxWidth: 800, margin: "auto", padding: 20, fontFamily: "Arial" }}>
      <h1>Pantry Inventory Manager</h1>

      {/* View Tabs */}
      <nav style={{ marginBottom: 20 }}>
        <button onClick={() => setView("manage")}>Manage Pantry</button>{" "}
        <button onClick={() => setView("overview")}>All Pantries Overview</button>{" "}
        <button onClick={() => setView("supply")}>Supply Inventory</button>
      </nav>

      {view === "manage" && (
        <div>
          {/* Pantry selection or creation */}
          {!selectedPantry ? (
            <CreatePantryForm onCreate={createPantry} />
          ) : (
            <div>
              <h2>
                Pantry: {selectedPantry.name} ({selectedPantry.location})
              </h2>
              <PantryItemManager
                pantry={selectedPantry}
                updatePantryItem={updatePantryItem}
              />
              <hr />
              <button onClick={() => setSelectedPantryId(null)}>Switch Pantry</button>
            </div>
          )}

          {/* Pantry selector if any */}
          {pantries.length > 0 && !selectedPantry && (
            <>
              <h3>Select Pantry to Manage</h3>
              <select
                onChange={(e) => setSelectedPantryId(e.target.value)}
                defaultValue=""
              >
                <option value="" disabled>
                  Select pantry
                </option>
                {pantries.map((p) => (
                  <option key={p.id} value={p.id}>
                    {p.name} ({p.location})
                  </option>
                ))}
              </select>
            </>
          )}
        </div>
      )}

      {view === "overview" && (
        <div>
          <h2>All Individual Pantries Inventory (Read-only)</h2>
          <InventoryTable items={combinedInventory()} />
        </div>
      )}

      {view === "supply" && (
        <div>
          <h2>Supply Inventory</h2>
          <SupplyManager supply={supply} updateSupply={updateSupply} />
        </div>
      )}
    </div>
  );
}

function CreatePantryForm({ onCreate }) {
  const [name, setName] = useState("");
  const [location, setLocation] = useState("");

  const submit = (e) => {
    e.preventDefault();
    if (!name.trim() || !location.trim()) return alert("Enter name and location");
    onCreate(name.trim(), location.trim());
    setName("");
    setLocation("");
  };

  return (
    <form onSubmit={submit} style={{ marginBottom: 20 }}>
      <h3>Create New Pantry</h3>
      <input
        placeholder="Name"
        value={name}
        onChange={(e) => setName(e.target.value)}
        required
      />{" "}
      <input
        placeholder="Location"
        value={location}
        onChange={(e) => setLocation(e.target.value)}
        required
      />{" "}
      <button type="submit">Create</button>
    </form>
  );
}

function PantryItemManager({ pantry, updatePantryItem }) {
  const [itemName, setItemName] = useState("");
  const [qtyChange, setQtyChange] = useState(0);

  const submit = (e) => {
    e.preventDefault();
    if (!itemName.trim()) return alert("Enter item name");
    const qtyNum = Number(qtyChange);
    if (isNaN(qtyNum) || qtyNum === 0) return alert("Quantity change cannot be zero");
    updatePantryItem(itemName.trim(), qtyNum);
    setItemName("");
    setQtyChange(0);
  };

  return (
    <div>
      <h3>Update Pantry Items</h3>
      <form onSubmit={submit}>
        <input
          placeholder="Item name"
          value={itemName}
          onChange={(e) => setItemName(e.target.value)}
          required
        />{" "}
        <input
          type="number"
          value={qtyChange}
          onChange={(e) => setQtyChange(e.target.value)}
          placeholder="Quantity change (+/-)"
          required
        />{" "}
        <button type="submit">Update</button>
      </form>

      <h4>Current Items</h4>
      <table border="1" cellPadding="5" cellSpacing="0">
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody>
          {pantry.items.map(({ name, qty, lastUpdated }) => (
            <tr key={name}>
              <td>{name}</td>
              <td>{qty}</td>
              <td>{lastUpdated}</td>
            </tr>
          ))}
          {pantry.items.length === 0 && (
            <tr>
              <td colSpan={3}>No items yet</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

function InventoryTable({ items }) {
  return (
    <table border="1" cellPadding="5" cellSpacing="0" style={{ width: "100%" }}>
      <thead>
        <tr>
          <th>Item</th>
          <th>Total Quantity</th>
        </tr>
      </thead>
      <tbody>
        {items.map(({ name, qty }) => (
          <tr key={name}>
            <td>{name}</td>
            <td>{qty}</td>
          </tr>
        ))}
        {items.length === 0 && (
          <tr>
            <td colSpan={2}>No items in inventory</td>
          </tr>
        )}
      </tbody>
    </table>
  );
}

function SupplyManager({ supply, updateSupply }) {
  const [itemName, setItemName] = useState("");
  const [qty, setQty] = useState(0);

  const submit = (e) => {
    e.preventDefault();
    if (!itemName.trim()) return alert("Enter item name");
    const qtyNum = Number(qty);
    if (isNaN(qtyNum) || qtyNum <= 0) return alert("Quantity must be positive");
    updateSupply(itemName.trim(), qtyNum);
    setItemName("");
    setQty(0);
  };

  return (
    <div>
      <form onSubmit={submit}>
        <input
          placeholder="Item name"
          value={itemName}
          onChange={(e) => setItemName(e.target.value)}
          required
        />{" "}
        <input
          type="number"
          placeholder="Quantity to add"
          value={qty}
          onChange={(e) => setQty(e.target.value)}
          required
          min="1"
        />{" "}
        <button type="submit">Add to Supply</button>
      </form>

      <h4>Current Supply Stock</h4>
      <InventoryTable items={supply} />
    </div>
  );
}

export default App;
